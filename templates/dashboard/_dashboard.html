<div class="parent-dashboard-modern">
    <!-- Welcome Header with Child Spotlight -->
    <div class="welcome-banner">
        <div class="welcome-content">
            <div class="welcome-greeting">
                <h1>Hello, {{ current_user.name }}! ðŸ‘‹</h1>
                <p class="welcome-subtitle">Let's see how {{ selected_child.name }} is growing today</p>
            </div>
        </div>
    </div>

    <!-- Child Spotlight Card -->
    <div class="child-spotlight-card">
        <div class="spotlight-left">
            <div class="child-avatar-modern">
                <div class="avatar-circle">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="avatar-decoration"></div>
            </div>
        </div>
        <div class="spotlight-right">
            <h2 class="child-name-modern">{{ selected_child.name }}</h2>
            <div class="child-meta">
                <span class="meta-item meta-age">
                    <i class="bi bi-cake2-fill"></i>
                    {{ selected_child.age }} years
                </span>
                <span class="meta-item meta-grade">
                    <i class="bi bi-book-fill"></i>
                    Grade {{ selected_child.grade_level }}
                </span>
                <span class="meta-item meta-gender">
                    <i class="bi bi-{{ 'gender-male' if selected_child.gender|lower == 'male' else 'gender-female' }}"></i>
                    {{ selected_child.gender }}
                </span>
            </div>
        </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats-grid">
        <!-- Total Subjects -->
        <div class="stat-bubble stat-bubble-coral">
            <div class="bubble-icon">
                <i class="bi bi-books"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">{{ subjects|length if subjects else 0 }}</div>
                <div class="bubble-label">Subjects</div>
            </div>
        </div>

        <!-- Average Score -->
        <div class="stat-bubble stat-bubble-teal">
            <div class="bubble-icon">
                <i class="bi bi-trophy-fill"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">
                    {% if scores %}
                        {{ "%.0f"|format((scores|sum(attribute='score')|float / scores|length) * 100) }}%
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="bubble-label">Avg Score</div>
            </div>
        </div>

        <!-- Total Assessments -->
        <div class="stat-bubble stat-bubble-amber">
            <div class="bubble-icon">
                <i class="bi bi-file-earmark-check-fill"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">{{ scores|length if scores else 0 }}</div>
                <div class="bubble-label">Tests</div>
            </div>
        </div>

        <!-- Progress Status -->
        <div class="stat-bubble stat-bubble-blue">
            <div class="bubble-icon">
                {% if scores %}
                    {% set avg = (scores|sum(attribute='score')|float / scores|length) * 100 %}
                    {% if avg >= 80 %}
                        <i class="bi bi-emoji-smile-fill"></i>
                    {% elif avg >= 60 %}
                        <i class="bi bi-emoji-neutral-fill"></i>
                    {% else %}
                        <i class="bi bi-emoji-frown-fill"></i>
                    {% endif %}
                {% else %}
                    <i class="bi bi-dash-circle-fill"></i>
                {% endif %}
            </div>
            <div class="bubble-content">
                <div class="bubble-value" style="font-size: 1.1rem;">
                    {% if scores %}
                        {% set avg = (scores|sum(attribute='score')|float / scores|length) * 100 %}
                        {% if avg >= 80 %}
                            Excellent
                        {% elif avg >= 60 %}
                            Good
                        {% else %}
                            Growing
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="bubble-label">Status</div>
            </div>
        </div>
    </div>

    <!-- Progress and Highlights Section -->
    <div class="dashboard-main-grid">
        <!-- Academic Progress Chart -->
        <div class="chart-card-modern">
            <div class="chart-header">
                <h3><i class="bi bi-graph-up"></i> Academic Progress</h3>
            </div>
            <div class="chart-body">
                {% if subjects %}
                    <canvas id="academicChart" style="height: 400px;"></canvas>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-clipboard-data"></i>
                        <p>No academic data yet</p>
                        <a href="{{ url_for('academic_progress') }}" class="btn-modern btn-modern-coral">
                            Add First Score
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Highlights -->
        <div class="highlights-card-modern">
            <div class="highlight-header">
                <h3><i class="bi bi-stars"></i> Highlights</h3>
            </div>
            <div class="highlight-body">
                <div class="highlight-item">
                    <div class="highlight-icon highlight-icon-star">
                        <i class="bi bi-trophy-fill"></i>
                    </div>
                    <div class="highlight-text">
                        <div class="highlight-label">Best Subject</div>
                        <div class="highlight-value">
                            {% if scores and subjects %}
                                {% set best_subject = namespace(name='N/A', score=0) %}
                                {% for subject in subjects %}
                                    {% set subject_scores = scores|selectattr('subject', 'equalto', subject)|list %}
                                    {% if subject_scores %}
                                        {% set avg = (subject_scores|sum(attribute='score')|float / subject_scores|length) * 100 %}
                                        {% if avg > best_subject.score %}
                                            {% set best_subject.name = subject %}
                                            {% set best_subject.score = avg %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {{ best_subject.name }}
                            {% else %}
                                Not yet
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="highlight-item">
                    <div class="highlight-icon highlight-icon-badge">
                        <i class="bi bi-patch-check-fill"></i>
                    </div>
                    <div class="highlight-text">
                        <div class="highlight-label">High Scores</div>
                        <div class="highlight-value">
                            {% if scores %}
                                {% set high_scores = scores|selectattr('score', 'ge', 0.8)|list|length %}
                                {{ high_scores }} achievement{{ 's' if high_scores != 1 else '' }}
                            {% else %}
                                0 achievements
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="highlight-item">
                    <div class="highlight-icon highlight-icon-calendar">
                        <i class="bi bi-calendar-event-fill"></i>
                    </div>
                    <div class="highlight-text">
                        <div class="highlight-label">Last Activity</div>
                        <div class="highlight-value">
                            {% if scores %}
                                {{ scores[-1].date.strftime('%b %d') if scores[-1].date else 'N/A' }}
                            {% else %}
                                No data
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explore Section -->
    <div class="section-header-modern">
        <h3><i class="bi bi-compass-fill"></i> Explore Tools</h3>
        <p>Discover features to support your child's growth</p>
    </div>

    <div class="explore-grid">
        <!-- Academic Progress -->
        <a href="{{ url_for('academic_progress') }}" class="explore-card explore-card-coral">
            <div class="explore-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <h4>Academic Progress</h4>
            <p>Track subject performance</p>
            <div class="explore-footer">
                <span>{{ subjects|length if subjects else 0 }} subjects</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>

        <!-- Preschool Tracker -->
        <a href="{{ url_for('preschool_tracker') }}" class="explore-card explore-card-teal">
            <div class="explore-icon">
                <i class="bi bi-balloon-heart-fill"></i>
            </div>
            <h4>Preschool Milestones</h4>
            <p>Developmental tracking</p>
            <div class="explore-footer">
                <span>Growth insights</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>

        <!-- Learning Style -->
        <a href="{{ url_for('learning_style') }}" class="explore-card explore-card-amber">
            <div class="explore-icon">
                <i class="bi bi-emoji-smile-fill"></i>
            </div>
            <h4>Learning Style</h4>
            <p>Discover how they learn</p>
            <div class="explore-footer">
                <span>Personalized</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>

        <!-- AI Insights -->
        <a href="{{ url_for('ai_insights') }}" class="explore-card explore-card-blue">
            <div class="explore-icon">
                <i class="bi bi-lightbulb-fill"></i>
            </div>
            <h4>AI Insights</h4>
            <p>Smart recommendations</p>
            <div class="explore-footer">
                <span>AI-powered</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>

        <!-- Learning Plan -->
        <a href="{{ url_for('learning_plan') }}" class="explore-card explore-card-purple">
            <div class="explore-icon">
                <i class="bi bi-calendar-check-fill"></i>
            </div>
            <h4>Learning Plan</h4>
            <p>Daily activities schedule</p>
            <div class="explore-footer">
                <span>Get organized</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>

        <!-- Resources Hub -->
        <a href="{{ url_for('resources_hub') }}" class="explore-card explore-card-green">
            <div class="explore-icon">
                <i class="bi bi-collection-fill"></i>
            </div>
            <h4>Resources</h4>
            <p>Educational materials</p>
            <div class="explore-footer">
                <span>Library</span>
                <i class="bi bi-arrow-right"></i>
            </div>
        </a>
    </div>

    <!-- Smart Insights Section -->
    <div class="section-header-modern">
        <h3><i class="bi bi-magic"></i> Smart Insights</h3>
        <p>AI-powered recommendations for your child</p>
    </div>

    <div class="insights-modern-grid">
        <!-- Preschool Performance -->
        <div class="insight-card-modern insight-card-teal">
            <div class="insight-header">
                <i class="bi bi-balloon-heart-fill"></i>
                <h4>Preschool Progress</h4>
            </div>
            <div class="insight-content">
                {% for p in preschool %}
                    {{ p|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Add preschool data to see insights</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Learning Style -->
        <div class="insight-card-modern insight-card-amber">
            <div class="insight-header">
                <i class="bi bi-emoji-smile-fill"></i>
                <h4>Learning Style</h4>
            </div>
            <div class="insight-content">
                {% for l in learning %}
                    {{ l|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Add observations to discover learning style</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recommendations -->
        <div class="insight-card-modern insight-card-blue">
            <div class="insight-header">
                <i class="bi bi-star-fill"></i>
                <h4>Recommendations</h4>
            </div>
            <div class="insight-content">
                {% for t in tutoring %}
                    {{ t|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Complete assessments for personalized tips</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const academicCtx = document.getElementById('academicChart');
  if (!academicCtx) return;

  const subjects = {{ subjects|tojson }};
  const allScores = {{ scores|tojson }};

  // Calculate average for each subject (in 0-100 scale)
  const averages = subjects.map(subject => {
    const subjectScores = allScores
      .filter(r => r.subject === subject)
      .map(r => r.score);

    if (subjectScores.length > 0) {
      return Math.round(
        (subjectScores.reduce((a, b) => a + b, 0) / subjectScores.length) * 100
      );
    }
    return 0;
  });

  // Color palette matching Academic Progress Tracker
  const barColors = [
    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
  ];

  new Chart(academicCtx, {
    type: 'bar',
    data: {
      labels: subjects,
      datasets: [{
        label: 'Average Score',
        data: averages,
        backgroundColor: barColors,
        borderColor: barColors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          borderColor: '#e5e7eb',
          borderWidth: 1
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: 100,
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            color: '#f3f4f6'
          },
          title: {
            display: true,
            text: 'Average Score',
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 12
            }
          },
          title: {
            display: true,
            text: 'Subject',
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        }
      }
    }
  });
});
</script>
