<div class="parent-dashboard-modern">
    <!-- Simple Header -->
    <div class="simple-header">
        <h2>{{ selected_child.name }}'s Dashboard</h2>
        <p class="header-subtitle">{{ selected_child.age }} years old â€¢ Grade {{ selected_child.grade_level }}</p>
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats-grid">
        <!-- Total Subjects -->
        <div class="stat-bubble stat-bubble-coral">
            <div class="bubble-icon">
                <i class="bi bi-books"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">{{ subjects|length if subjects else 0 }}</div>
                <div class="bubble-label">Subjects</div>
            </div>
        </div>

        <!-- Average Score -->
        <div class="stat-bubble stat-bubble-teal">
            <div class="bubble-icon">
                <i class="bi bi-trophy-fill"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">
                    {% if scores %}
                        {{ "%.0f"|format((scores|sum(attribute='score')|float / scores|length) * 100) }}%
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="bubble-label">Avg Score</div>
            </div>
        </div>

        <!-- Total Assessments -->
        <div class="stat-bubble stat-bubble-amber">
            <div class="bubble-icon">
                <i class="bi bi-file-earmark-check-fill"></i>
            </div>
            <div class="bubble-content">
                <div class="bubble-value">{{ scores|length if scores else 0 }}</div>
                <div class="bubble-label">Tests</div>
            </div>
        </div>

        <!-- Progress Status -->
        <div class="stat-bubble stat-bubble-blue">
            <div class="bubble-icon">
                {% if scores %}
                    {% set avg = (scores|sum(attribute='score')|float / scores|length) * 100 %}
                    {% if avg >= 80 %}
                        <i class="bi bi-emoji-smile-fill"></i>
                    {% elif avg >= 60 %}
                        <i class="bi bi-emoji-neutral-fill"></i>
                    {% else %}
                        <i class="bi bi-emoji-frown-fill"></i>
                    {% endif %}
                {% else %}
                    <i class="bi bi-dash-circle-fill"></i>
                {% endif %}
            </div>
            <div class="bubble-content">
                <div class="bubble-value" style="font-size: 1.1rem;">
                    {% if scores %}
                        {% set avg = (scores|sum(attribute='score')|float / scores|length) * 100 %}
                        {% if avg >= 80 %}
                            Excellent
                        {% elif avg >= 60 %}
                            Good
                        {% else %}
                            Growing
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="bubble-label">Status</div>
            </div>
        </div>
    </div>

    <!-- Academic Progress Chart - Full Width -->
    <div class="chart-card-modern-full">
        <div class="chart-header">
            <h3><i class="bi bi-graph-up"></i> Academic Progress (Current Year)</h3>
        </div>
        <div class="chart-body">
            {% if subjects %}
                <canvas id="academicChart" style="height: 400px;"></canvas>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-clipboard-data"></i>
                    <p>No academic data yet</p>
                    <a href="{{ url_for('academic_progress') }}" class="btn-modern btn-modern-coral">
                        Add First Score
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Smart Insights Section -->
    <div class="section-header-modern">
        <h3><i class="bi bi-magic"></i> Smart Insights</h3>
        <p>AI-powered recommendations for your child</p>
    </div>

    <div class="insights-modern-grid">
        <!-- Preschool Performance -->
        <div class="insight-card-modern insight-card-teal">
            <div class="insight-header">
                <i class="bi bi-balloon-heart-fill"></i>
                <h4>Preschool Progress</h4>
            </div>
            <div class="insight-content">
                {% for p in preschool %}
                    {{ p|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Add preschool data to see insights</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Learning Style -->
        <div class="insight-card-modern insight-card-amber">
            <div class="insight-header">
                <i class="bi bi-emoji-smile-fill"></i>
                <h4>Learning Style</h4>
            </div>
            <div class="insight-content">
                {% for l in learning %}
                    {{ l|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Add observations to discover learning style</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recommendations -->
        <div class="insight-card-modern insight-card-blue">
            <div class="insight-header">
                <i class="bi bi-star-fill"></i>
                <h4>Recommendations</h4>
            </div>
            <div class="insight-content">
                {% for t in tutoring %}
                    {{ t|safe }}
                {% else %}
                    <div class="insight-empty">
                        <i class="bi bi-info-circle"></i>
                        <p>Complete assessments for personalized tips</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const academicCtx = document.getElementById('academicChart');
  if (!academicCtx) return;

  const subjects = {{ subjects|tojson }};
  const allScores = {{ scores|tojson }};

  // Filter scores for current year only
  const currentYear = new Date().getFullYear();
  const currentYearScores = allScores.filter(score => {
    if (!score.date) return false;
    const scoreYear = new Date(score.date).getFullYear();
    return scoreYear === currentYear;
  });

  // Calculate average for each subject (current year only)
  const averages = subjects.map(subject => {
    const subjectScores = currentYearScores
      .filter(r => r.subject === subject)
      .map(r => r.score);

    if (subjectScores.length > 0) {
      return Math.round(
        (subjectScores.reduce((a, b) => a + b, 0) / subjectScores.length) * 100
      ) / 100;
    }
    return 0;
  });

  new Chart(academicCtx, {
    type: 'bar',
    data: {
      labels: subjects,
      datasets: [{
        label: 'Average Score',
        data: averages,
        backgroundColor: [
          '#3B82F6',  // Blue
          '#F97316',  // Orange
          '#10B981',  // Green
          '#EF4444',  // Red
          '#8B5CF6',  // Purple
          '#14B8A6',  // Teal
          '#F59E0B',  // Amber
          '#EC4899'   // Pink
        ],
        borderWidth: 0,
        barPercentage: 0.7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          callbacks: {
            label: function(context) {
              return 'Average Score: ' + (context.parsed.y * 100).toFixed(1) + '%';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 1,
          grid: {
            color: '#E5E7EB',
            drawBorder: false
          },
          ticks: {
            callback: function(value) {
              return (value * 100) + '%';
            },
            font: {
              size: 12
            },
            color: '#6B7280'
          },
          title: {
            display: true,
            text: 'Average Score',
            font: {
              size: 13,
              weight: 'bold'
            },
            color: '#374151'
          }
        },
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            font: {
              size: 12,
              weight: '500'
            },
            color: '#374151'
          },
          title: {
            display: true,
            text: 'Subject',
            font: {
              size: 13,
              weight: 'bold'
            },
            color: '#374151'
          }
        }
      }
    }
  });
});
</script>
