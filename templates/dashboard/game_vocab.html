{% extends "base.html" %}
{% block content %}
<div class="container-fluid game-page-bg py-4">
    
    <div class="game-wrapper mx-auto">
        <div class="game-card shadow-lg rounded-4 p-4">
            <div class="game-header-top d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-2">
                    <span class="game-title-icon">üéÆ</span>
                    <div>
                        <h4 class="mb-0">{{ game.title }}</h4>
                        <small class="text-muted">{{ game.description or '' }}</small>
                    </div>
                </div>
                <div class="text-end small text-muted">
                    Question <span id="question-counter">1</span> /
                    <span id="question-max">5</span><br>
                    Score: <span id="score">0</span> / <span id="total">0</span>
                </div>
            </div>

            <style>
                .game-page-bg {
                    background: linear-gradient(180deg, #fff7f2 0%, #f0faff 100%);
                    min-height: calc(100vh - 80px);
                }
                .game-wrapper {
                    max-width: 900px;
                }
                .game-card {
                    background: #ffffff;
                    border-radius: 1.5rem;
                    border: 1px solid rgba(0,0,0,0.03);
                }
                .game-title-icon {
                    font-size: 2.2rem;
                }
                .badge-pill {
                    border-radius: 999px;
                }
                .game-meta-badges {
                    display: flex;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                    margin-top: 0.6rem;
                }
                .vocab-zone {
                    background: #fffdf8;
                    border-radius: 1.25rem;
                    border: 1px dashed #ffd6a3;
                    padding: 1.8rem 1rem 1.4rem;
                    margin-bottom: 1.25rem;
                    text-align: center;
                }
                .vocab-emoji {
                    font-size: 4rem;
                    display: inline-block;
                    animation: vocabPop 0.35s ease-out;
                }
                @keyframes vocabPop {
                    0%   { transform: scale(0.4); opacity: 0; }
                    60%  { transform: scale(1.15); opacity: 1; }
                    100% { transform: scale(1); }
                }
                .vocab-word-hint {
                    color: #888;
                    font-size: 0.9rem;
                }
                .vocab-answer-btn {
                    min-width: 120px;
                    border-radius: 999px !important;
                    font-size: 1.05rem;
                    padding: 0.55rem 1.3rem;
                    margin-bottom: 0.5rem;
                    transition: transform 0.1s ease, box-shadow 0.1s ease;
                }
                .vocab-answer-btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
                }
                .status-text {
                    min-height: 1.4rem;
                    font-weight: 600;
                }
                .progress {
                    background-color: #ffe9dd;
                    border-radius: 999px;
                }
                .progress-bar {
                    background: linear-gradient(90deg, #ff9f45, #ff6b81);
                    border-radius: 999px;
                }
                .finish-btn {
                    border-radius: 999px;
                    padding-inline: 1.4rem;
                }
            </style>

            <div class="game-meta-badges">
                <span class="badge bg-info text-dark badge-pill">Vocabulary Game</span>
                <span class="badge bg-success badge-pill">Easy</span>
                <span class="badge bg-warning text-dark badge-pill">üß† Learn new words</span>
            </div>

            <hr class="mt-3 mb-3">

            <p class="fw-semibold mb-2">
                <span class="text-primary">Instructions:</span>
                Look at the animal and tap the correct English word.
            </p>

            <div id="vocab-game-area">
                <div class="vocab-zone">
                    <div id="vocab-question" class="mb-2 fw-semibold">What animal is this?</div>
                    <div id="vocab-emoji" class="mb-2"></div>
                    <div class="vocab-word-hint">
                        Say the word out loud, then choose it below.
                    </div>
                </div>

                <div id="vocab-answers" class="mb-3 d-flex flex-wrap justify-content-center gap-2"></div>

                <div id="vocab-feedback" class="status-text text-center mb-2"></div>

                <div class="progress mb-3" style="height: 10px;">
                    <div id="vocab-progress-bar" class="progress-bar" role="progressbar"
                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <div class="d-flex flex-column align-items-center">
                    <button id="vocab-finish-btn" class="btn btn-primary mt-1 finish-btn" disabled>
                        Finish &amp; Save Result
                    </button>
                    <div id="vocab-save-status" class="mt-3"></div>
                </div>
            </div>

            <audio id="sound-correct"
                   src="{{ url_for('static', filename='sounds/correct.mp3') }}"></audio>
            <audio id="sound-wrong"
                   src="{{ url_for('static', filename='sounds/wrong.mp3') }}"></audio>

            <script>
                const childId2 = {{ selected_child.id }};
                const gameId2 = {{ game.id }};
                const saveResultUrl2 = "{{ url_for('save_game_result') }}";

                const scoreSpan2 = document.getElementById("score");
                const totalSpan2 = document.getElementById("total");
                const questionCounter2 = document.getElementById("question-counter");
                const questionMax2 = document.getElementById("question-max");
                const emojiDiv = document.getElementById("vocab-emoji");
                const answersDiv2 = document.getElementById("vocab-answers");
                const feedbackDiv2 = document.getElementById("vocab-feedback");
                const finishBtn2 = document.getElementById("vocab-finish-btn");
                const saveStatusDiv2 = document.getElementById("vocab-save-status");
                const progressBar2 = document.getElementById("vocab-progress-bar");
                const soundCorrect2 = document.getElementById("sound-correct");
                const soundWrong2 = document.getElementById("sound-wrong");

                let vocabScore = 0;
                let vocabTotalQuestions = 0;
                let vocabCurrentCorrect = null;
                let vocabStartTime = Date.now();
                const vocabMaxQuestions = 5;

                questionMax2.innerText = vocabMaxQuestions.toString();

                const vocabItems = [
                    { emoji: "üê±", word: "cat",    choices: ["cat", "dog", "fish"] },
                    { emoji: "üê∂", word: "dog",    choices: ["duck", "dog", "cow"] },
                    { emoji: "üê∞", word: "rabbit", choices: ["rabbit", "lion", "bear"] },
                    { emoji: "üêª", word: "bear",   choices: ["horse", "bear", "frog"] },
                    { emoji: "üêº", word: "panda",  choices: ["panda", "bird", "mouse"] },
                    { emoji: "üê∏", word: "frog",   choices: ["cat", "frog", "sheep"] },
                    { emoji: "üê¥", word: "horse",  choices: ["horse", "duck", "pig"] },
                    { emoji: "üê∑", word: "pig",    choices: ["cow", "goat", "pig"] },
                    { emoji: "üêµ", word: "monkey", choices: ["monkey", "tiger", "zebra"] }
                ];

                let vocabOrder = [];
                for (let i = 0; i < vocabItems.length; i++) {
                    vocabOrder.push(i);
                }
                vocabOrder.sort(() => Math.random() - 0.5);

                function playSound2(audioElement) {
                    if (audioElement && audioElement.play) {
                        audioElement.currentTime = 0;
                        audioElement.play().catch(() => {});
                    }
                }

                function updateVocabProgress() {
                    const percentage = Math.round((vocabTotalQuestions / vocabMaxQuestions) * 100);
                    progressBar2.style.width = percentage + "%";
                    progressBar2.setAttribute("aria-valuenow", percentage);
                }

                function generateVocabQuestion() {
                    if (vocabTotalQuestions >= vocabMaxQuestions) {
                        finishBtn2.disabled = false;
                        feedbackDiv2.innerHTML =
                            "<span class='text-success'>Great job learning animal words! üêæ</span>";
                        emojiDiv.innerHTML = "";
                        answersDiv2.innerHTML = "";
                        questionCounter2.innerText = vocabMaxQuestions.toString();
                        updateVocabProgress();
                        return;
                    }

                    const index = vocabOrder[vocabTotalQuestions % vocabOrder.length];
                    const item = vocabItems[index];

                    vocabCurrentCorrect = item.word;
                    vocabTotalQuestions++;

                    totalSpan2.innerText = String(vocabTotalQuestions);
                    questionCounter2.innerText = String(vocabTotalQuestions);
                    feedbackDiv2.innerText = "";

                    emojiDiv.innerHTML = "<span class='vocab-emoji'>" + item.emoji + "</span>";
                    updateVocabProgress();

                    const options = [...item.choices];
                    options.sort(() => Math.random() - 0.5);

                    answersDiv2.innerHTML = "";
                    options.forEach(function (opt) {
                        const btn = document.createElement("button");
                        btn.className = "btn btn-outline-primary vocab-answer-btn";
                        btn.innerText = opt;
                        btn.onclick = function () { checkVocabAnswer(opt); };
                        answersDiv2.appendChild(btn);
                    });
                }

                function checkVocabAnswer(selected) {
                    if (vocabTotalQuestions > vocabMaxQuestions) return;

                    if (selected === vocabCurrentCorrect) {
                        vocabScore++;
                        scoreSpan2.innerText = String(vocabScore);
                        feedbackDiv2.innerHTML =
                            "<span class='text-success'>Correct! \"" +
                            vocabCurrentCorrect + "\" ü•≥</span>";
                        playSound2(soundCorrect2);
                    } else {
                        feedbackDiv2.innerHTML =
                            "<span class='text-danger'>Not quite, this is \"" +
                            vocabCurrentCorrect + "\".</span>";
                        playSound2(soundWrong2);
                    }

                    setTimeout(generateVocabQuestion, 1100);
                }

                finishBtn2.addEventListener("click", function () {
                    const timeSpent = Math.floor((Date.now() - vocabStartTime) / 1000);

                    const payload = {
                        child_id: childId2,
                        game_id: gameId2,
                        score: vocabScore,
                        total_questions: vocabTotalQuestions,
                        time_spent_seconds: timeSpent
                    };

                    fetch(saveResultUrl2, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        let msg;
                        if (data.success) {
                            msg = "<span class='text-success'>Result saved successfully! üìö</span>";
                        } else {
                            msg = "<span class='text-danger'>Failed to save result.</span>";
                        }
                        saveStatusDiv2.innerHTML = msg;
                    })
                    .catch(err => {
                        saveStatusDiv2.innerHTML =
                            "<span class='text-danger'>Error saving result.</span>";
                    });

                    this.disabled = true;
                });

                window.addEventListener("load", generateVocabQuestion);
            </script>

            <div class="mt-3 d-flex justify-content-end">
                <a href="{{ url_for('dashboard_games') }}" class="btn btn-outline-secondary">
                    Back to Games
                </a>
            </div>

        </div>
    </div>
</div>
{% endblock %}
