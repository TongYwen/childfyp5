<style>
  .questionnaire-card {
    height: 130px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.questionnaire-card .card-body {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.questionnaire-card h6 {
    height: 40px;  /* fixed text block height */
    display: flex;
    align-items: center;
    text-align: center;
}

  .questionnaire-card {
    border-radius: 0.75rem;
    border: 1px solid #e4e4e4;
    box-shadow: 0 2px 4px rgba(15, 23, 42, 0.03);
    transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
  }
  .questionnaire-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
    border-color: #7c6dfb;
    cursor: pointer;
  }
  .questionnaire-card-completed {
    border-color: #198754;
    background: #f6fff8;
  }
  .questionnaire-card .badge {
    font-size: 0.75rem;
  }

  .learning-card-section {
  background: #ffffff;
  border: 1px solid #dadada;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
</style>


<h2>Learning Style Analyzer</h2>

<p class="text-muted">
  This module analyzes your child's learning style using:
  <strong>(1)</strong> parent questionnaires for each learning style
  and <strong>(2)</strong> your daily observations about your child.
</p>

<ol class="small text-muted mb-3">
  <li>Choose a questionnaire (Visual, Auditory, Reading/Writing, Kinesthetic).</li>
  <li>Answer the questions based on your child's usual behaviour.</li>
  <li>Add any extra observations you notice in daily life.</li>
  <li>Click <strong>Regenerate</strong> to get AI learning style insights.</li>
</ol>


{# Build a map of completed questionnaires #}
{% set completed_map = {} %}
{% for ans in test_answers %}
  {% set completed_map = completed_map.update({ans.test_id: True}) or completed_map %}
{% endfor %}



<div class="learning-card-section mb-4 px-3 py-3">
<!-- Questionnaire cards -->
<div class="row mb-3">
  {% for test in user_tests %}
    <div class="col-md-3 mb-3">
      <div class="card questionnaire-card text-center {% if completed_map.get(test.id) %}questionnaire-card-completed{% endif %}"
           data-test-id="{{ test.id }}">
        <div class="card-body p-3">
          <h6 class="card-title mb-2">{{ test.name }}</h6>

          {% if completed_map.get(test.id) %}
            <span class="badge bg-success">
              <i class="fa-solid fa-circle-check me-1"></i>Completed
            </span>
          {% else %}
            <span class="badge bg-light text-muted border">
              <i class="fa-regular fa-circle me-1"></i>Not completed
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>



<!-- Button to trigger AI generation -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <button type="button"
          class="btn btn-outline-success"
          data-bs-toggle="modal"
          data-bs-target="#inputObservationModal">
    <i class="fa-solid fa-plus me-1"></i> Add Observation
  </button>

  <button id="generateInsightsBtn" class="btn btn-primary">
    Generate Learning Style Insights
  </button>
</div>
</div>



<!-- Top Card: Learning Strategies -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title">Learning Strategies</h5>
      <div>
    
        <!-- Regenerate button with reload icon -->
        <button id="regenBtn" class="btn btn-outline-primary btn-sm" title="Regenerate Analysis">
          <i class="fa fa-sync-alt"></i>
        </button>
      </div>
    </div>

    {% if last_generated %}
      <p class="text-muted small mb-2">
        Last generated on {{ last_generated.strftime('%Y-%m-%d %H:%M:%S') }}
      </p>
    {% endif %}

     <!-- AI result area -->
      <div id="benchmarkResult">
      {% if benchmark_summary %}
        {{ benchmark_summary|safe }}
      {% else %}
        <p class="text-muted">No AI insights available yet.</p>
      {% endif %}
    </div>

    <!-- Loading text -->
    <div id="loadingText" class="text-center text-primary fw-bold mt-3" style="display:none;">
      <i class="fa fa-spinner fa-spin me-2"></i> Analyzing learning style... please wait.
    </div>
  </div>
</div>

<!-- Tabs for Test Answers and Observations -->
<ul class="nav nav-tabs mt-4" id="learningTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="test-answers-tab" data-bs-toggle="tab" data-bs-target="#test-answers" type="button" role="tab">
      Questionnaire Answers
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="observations-tab" data-bs-toggle="tab" data-bs-target="#observations" type="button" role="tab">
      Observations
    </button>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- Test Answers Tab -->
  <div class="tab-pane fade show active" id="test-answers" role="tabpanel">
    {% if test_answers %}
      <div class="accordion" id="testAnswersAccordion">
        {% set tests_grouped = {} %}
        {% for ans in test_answers %}
          {% if ans.test_id not in tests_grouped %}
            {% set tests_grouped = tests_grouped.update({ans.test_id: [ans]}) or tests_grouped %}
          {% else %}
            {% set _ = tests_grouped[ans.test_id].append(ans) %}
          {% endif %}
        {% endfor %}

        {% for test_id, answers in tests_grouped.items() %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ test_id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ test_id }}" aria-expanded="false" aria-controls="collapse{{ test_id }}">
                {{ answers[0].test_name }}
              </button>
            </h2>
            <div id="collapse{{ test_id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ test_id }}" data-bs-parent="#testAnswersAccordion">
              <div class="accordion-body p-0">
                <table class="table table-bordered mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Question</th>
                      <th>Answer</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ans in answers %}
                      <tr>
                        <td>{{ ans.question_text }}</td>
                        <td>{{ ans.answer }}</td>
                        <td>{{ ans.created_at.strftime('%Y-%m-%d') }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
    <p class="text-center text-muted">No questionnaire answers recorded yet.</p>
    {% endif %}
  </div>

  <!-- Observations Tab -->
  <div class="tab-pane fade" id="observations" role="tabpanel">
    {% if learning_notes %}
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Observation</th>
              <th>Date</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for note in learning_notes %}
              <tr>
                <td>{{ note.observation }}</td>
                <td>{{ note.created_at.strftime('%Y-%m-%d') }}</td>
                <td class="text-center">
                  <form method="POST" action="{{ url_for('delete_learning_observation', observation_id=note.id) }}" class="delete-observation-form">
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-center text-muted">No observations recorded yet.</p>
    {% endif %}
  </div>
</div>

<!-- Modal 1: Select Questionnaire -->
<div class="modal fade" id="selectTestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
         <h5 class="modal-title">Select a Parent Questionnaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p class="text-muted small">
          Answer one or more questionnaires based on your child's usual behaviour.
          Each questionnaire focuses on one learning style:
          <strong>Visual</strong>, <strong>Auditory</strong>,
          <strong>Reading/Writing</strong>, or <strong>Kinesthetic</strong>.
        </p>

          <div class="mb-3"></div>
          <label class="form-label">Choose Parent Questionnaire</label>
          <select id="testSelectDropdown" class="form-select" required></select>
          <option value="">-- Select Questionnaire --</option>
          {% for test in user_tests %}
              {# 
                Recommended convention:
                Admin creates tests named for example:
                "Visual Learning Questionnaire",
                "Auditory Learning Questionnaire", etc.
              #}
              <option value="{{ test.id }}">{{ test.name }}</option>
            {% endfor %}
          </select>
        </div>

        <small class="text-muted">
          Tip: Answer more than one questionnaire for more accurate analysis.
        </small>
      </div>  

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="openTestQuestionsBtn" disabled>Next</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
    </div>
  </div>
</div>

<!-- Modal 2: Test Questions -->
<div class="modal fade" id="testQuestionsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" id="testQuestionsForm" action="{{ url_for('take_learning_test', child_id=selected_child.id) }}">
      <div class="modal-content">
        <div class="modal-header">
                  <h5 class="modal-title">Answer Questionnaire About Your Child</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

        <div class="modal-body">
          <input type="hidden" name="test_id" id="selectedTestId">
          <div id="testQuestionsContainer"></div>
           </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit Answers</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Input Observation Modal -->
<div class="modal fade" id="inputObservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('submit_learning_observation', child_id=selected_child.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Submit Observation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Observation</label>
            <textarea name="observation" class="form-control" placeholder="E.g. Prefers hands-on activities" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const regenBtn = document.getElementById("regenBtn");
  const generateInsightsBtn = document.getElementById("generateInsightsBtn");
  const resultDiv = document.getElementById("benchmarkResult");
  const loadingText = document.getElementById("loadingText");

  const testSelectDropdown = document.getElementById('testSelectDropdown');
  const openTestQuestionsBtn = document.getElementById('openTestQuestionsBtn');
  const testQuestionsModalEl = document.getElementById('testQuestionsModal');
  const testQuestionsModal = new bootstrap.Modal(testQuestionsModalEl);
  const testQuestionsContainer = document.getElementById('testQuestionsContainer');
  const selectedTestIdInput = document.getElementById('selectedTestId');

  const questionnaireCards = document.querySelectorAll('.questionnaire-card');

  // Base /static/ path for media
  const STATIC_ROOT = "{{ url_for('static', filename='') }}";  // e.g. "/static/"

   // ---------- Helper: load questions for a given test ----------
  function loadTestQuestions(testId) {
    if (!testId) return;

    selectedTestIdInput.value = testId;
    testQuestionsContainer.innerHTML = '';
     fetch(`/learning/test_questions/${testId}`)
      .then(res => res.json())
      .then(data => {
        console.log("test questions", data);
        if (!data.length) {
          testQuestionsContainer.innerHTML =
          "<p class='text-muted'>No questions found for this questionnaire.</p>";
          return;
        }

        data.forEach((q, i) => {
          const div = document.createElement('div');
          div.className = 'mb-3 p-3 border rounded';

          // Build media HTML if exists
          let mediaHtml = "";
          if (q.media_type && q.media_path) {
            const fullPath = STATIC_ROOT + q.media_path;  // "uploads/questions/..." appended

            if (q.media_type === "image") {
              mediaHtml = `
                <div class="mb-2 text-center">
                  <img src="${fullPath}" alt="Question media"
                       style="max-height:200px; max-width:100%; margin-bottom:10px;">
                </div>
              `;
            } else if (q.media_type === "audio") {
              mediaHtml = `
                <div class="mb-2">
                  <audio controls style="width:100%; margin-bottom:10px;">
                    <source src="${fullPath}">
                    Your browser does not support the audio element.
                  </audio>
                </div>
              `;
            }
          }

           div.innerHTML = `
            ${mediaHtml}
            <label class="form-label fw-semibold">${i + 1}. ${q.question}</label>

            ${
              q.answer_type === 'scale'
              ? `
                  <div class="d-flex gap-3 mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[${i}][answer]" id="q${q.id}_1" value="1" required>
                      <label class="form-check-label" for="q${q.id}_1">1</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[${i}][answer]" id="q${q.id}_2" value="2" required>
                      <label class="form-check-label" for="q${q.id}_2">2</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[${i}][answer]" id="q${q.id}_3" value="3" required>
                      <label class="form-check-label" for="q${q.id}_3">3</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[${i}][answer]" id="q${q.id}_4" value="4" required>
                      <label class="form-check-label" for="q${q.id}_4">4</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[${i}][answer]" id="q${q.id}_5" value="5" required>
                      <label class="form-check-label" for="q${q.id}_5">5</label>
                    </div>
                  </div>
                `
                : `
                  <select name="answers[${i}][answer]" class="form-select" required>
                    <option value="">-- Select --</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                `
            }

            <input type="hidden" name="answers[${i}][question_id]" value="${q.id}">
          `;

          testQuestionsContainer.appendChild(div);
        });

         // Hide select modal if open, then show questions modal
        const selectModalEl = document.getElementById('selectTestModal');
         if (selectModalEl) {
          const existingModal = bootstrap.Modal.getInstance(selectModalEl);
          if (existingModal) existingModal.hide();
        }
        testQuestionsModal.show();
      });
  }

  // ---------- Select Test Modal (dropdown flow) ----------
  if (testSelectDropdown) {
    testSelectDropdown.addEventListener('change', function() {
      openTestQuestionsBtn.disabled = !this.value;
    });
  }

  if (openTestQuestionsBtn) {
    openTestQuestionsBtn.addEventListener('click', function() {
      const testId = testSelectDropdown.value;
      loadTestQuestions(testId);
    });
  }

  // ---------- Questionnaire cards: click to answer ----------
  questionnaireCards.forEach(card => {
    card.addEventListener('click', function() {
      const testId = this.dataset.testId;
      loadTestQuestions(testId);
    });
  });

  // ---------- Generate Insights button -> trigger regenBtn ----------
  if (generateInsightsBtn && regenBtn) {
    generateInsightsBtn.addEventListener('click', function() {
      regenBtn.click();
    });
  }

  // ---------- Delete Observation SweetAlert ----------
  const deleteForms = document.querySelectorAll('.delete-observation-form');
  deleteForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // prevent default form submit
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });


  // ---------- Regenerate AI analysis (AJAX) ----------
  if (regenBtn) {
    regenBtn.addEventListener("click", async function() {
      regenBtn.disabled = true;
      regenBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

        if (loadingText) loadingText.style.display = "block";
      if (resultDiv) resultDiv.style.opacity = "0.5";
      try {
        const res = await fetch(window.location.pathname + "?regen=1", {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await res.json();
        if (data.error === "token_limit") {
          Swal.fire({
            icon: "error",
            title: "Gemini API Limit Reached",
            text: "Please update your Google API key in settings."
          });
        } else {
          if (data.benchmark_summary && resultDiv) {
            resultDiv.innerHTML = data.benchmark_summary;
          }
          if (data.last_generated) {
            const small = document.querySelector(".small.mb-2");
            if (small) small.textContent = "Last generated on " + data.last_generated;
          }
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
           title: "Error",
          text: "Failed to regenerate analysis. Please try again."
        });
         } finally {
        regenBtn.disabled = false;
        regenBtn.innerHTML = '<i class="fa fa-sync-alt"></i>';
        if (loadingText) loadingText.style.display = "none";
        if (resultDiv) resultDiv.style.opacity = "1";
      }
       });
  }
});
</script>









