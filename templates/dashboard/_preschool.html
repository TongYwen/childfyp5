<h3>Preschool Performance Tracker</h3>

<!-- Top Card: Benchmark Comparison -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title">Benchmark Comparison</h5>
      <div>
        <span class="badge bg-info text-dark me-2">
         AI Generated 
        </span>
        <button id="regenBtn" class="btn btn-outline-primary btn-sm" title="Regenerate Benchmark">
          <i class="fa-solid fa-rotate"></i>
        </button>
      </div>
    </div>

    {% if last_generated %}
      <p class="text-muted small mb-2">
        Last generated on {{ last_generated.strftime('%Y-%m-%d %H:%M:%S') }}
      </p>
    {% endif %}

    {% if benchmark_summary %}
      <div id="benchmarkResult">{{ benchmark_summary|safe }}</div>
    {% else %}
      <p class="text-muted">No benchmark data available yet.</p>
    {% endif %}

    <div id="loadingText" class="text-center text-primary fw-bold mt-3" style="display:none;">
      <i class="fa fa-spinner fa-spin me-2"></i> Analyzing... please wait.
    </div>
  </div>
</div>

<!-- Bottom Card -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title">Records</h5>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAssessmentModal">
        + Add
      </button>
    </div>

    {% if assessments|length == 0 %}
      <p class="text-muted text-center">No assessments yet. Please add records above.</p>
    {% else %}
      <!-- Horizontal/zigzag timeline -->
      <div class="timeline d-flex flex-wrap position-relative">
        {% for record in assessments %}
        <div class="timeline-item p-2 flex-grow-1" style="min-width:250px; max-width:280px; position:relative;">
          <div class="card shadow-sm h-100">
            <div class="card-body position-relative">
              <!-- Delete button -->
              <form method="POST" action="{{ url_for('delete_preschool', id=record.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this record?');"
                    style="position:absolute; top:10px; right:10px;">
                <button type="submit" class="btn btn-sm">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>

              <h6 class="fw-bold">{{ record.date_str }}</h6>
              <p><strong>Domain:</strong> {{ record.domain }}</p>
              <p><strong>Description:</strong> {{ record.description }}</p>
            </div>
          </div>

          <!-- Horizontal connector -->
          {% if not loop.last %}
          <div class="connector-horizontal d-none d-md-block"></div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Add Assessment Modal -->
<div class="modal fade" id="addAssessmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('preschool_tracker') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Preschool Assessment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Domain -->
          <div class="mb-3">
            <label class="form-label">Domain</label>
            <select name="domain" class="form-select" required>
              <option value="">-- Select Domain --</option>
              <option>Social/Emotional Milestones</option>
              <option>Cognitive Milestones</option>
              <option>Language/Communication</option>
              <option>Movement/Physical Development</option>
            </select>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label">Description</label>
            <input type="text" name="description" class="form-control" placeholder="Enter observation/assessment" required>
          </div>

          <!-- Date (Year-Month only) -->
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="month" name="date" class="form-control" required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const regenBtn = document.getElementById("regenBtn");
  const resultDiv = document.getElementById("benchmarkResult");
  const loadingText = document.getElementById("loadingText");

  regenBtn.addEventListener("click", async function() {
    // Disable button and show spinner
    regenBtn.disabled = true;
    const originalHTML = regenBtn.innerHTML;
    regenBtn.innerHTML = `<i class="fa fa-spinner fa-spin me-2"></i>`;

    // Show loading message inside card
    loadingText.style.display = "block";
    if (resultDiv) {
      resultDiv.style.display = "none";
    }

    try {
      const res = await fetch("/dashboard/preschool/regenerate", { method: "POST" });

      if (!res.ok) {
        console.error("HTTP error:", res.status, res.statusText);
        const errorText = await res.text();
        console.error("Response:", errorText);
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      console.log("Response data:", data);

      if (data.error === "token_limit") {
        Swal.fire({
          icon: "error",
          title: "Gemini API Limit Reached",
          html: `
            Your Google AI key has reached its usage limit or expired.<br>
            <strong>Please update your API key in Settings.</strong>
          `,
        });
      } else if (data.error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.error
        });
      } else if (data.success) {
        // Update the benchmark summary dynamically
        if (resultDiv) {
          resultDiv.innerHTML = data.benchmark_summary;

          // Update "last generated" timestamp
          let lastGen = document.querySelector(".text-muted.small.mb-2");
          if (lastGen) {
            lastGen.textContent = `Last generated on ${data.last_generated}`;
          } else {
            const newP = document.createElement("p");
            newP.className = "text-muted small mb-2";
            newP.textContent = `Last generated on ${data.last_generated}`;
            resultDiv.parentElement.insertBefore(newP, resultDiv);
          }
        }
      }
    } catch (err) {
      console.error("Fetch error:", err);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Failed to regenerate benchmark. Please try again later."
      });
    } finally {
      // Restore button state and content
      regenBtn.disabled = false;
      regenBtn.innerHTML = originalHTML;

      // Hide loading text and show results again
      loadingText.style.display = "none";
      if (resultDiv) {
        resultDiv.style.display = "block";
      }
    }
  });
});
</script>